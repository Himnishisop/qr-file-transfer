<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Sender</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body {
  background:#000;
  color:#fff;
  font-family:sans-serif;
  overflow:hidden;
}
#cart {
  position:fixed;
  bottom:-200px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  height:150px;
  background:#7c3aed;
  border-radius:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  transition:.5s;
}
#cart.show {
  bottom:20px;
}
#cart.swipe {
  bottom:120%;
  opacity:0;
}
</style>
</head>

<body>
<input type="file" id="file" />

<div id="cart">ðŸ“¦ Swipe Up to Send</div>

<script>
const socket = io();
const input = document.getElementById("file");
const cart = document.getElementById("cart");

let file;

input.onchange = () => {
  file = input.files[0];
  cart.classList.add("show");
};

let startY = 0;
cart.addEventListener("touchstart", e => startY = e.touches[0].clientY);
cart.addEventListener("touchend", e => {
  let endY = e.changedTouches[0].clientY;
  if (startY - endY > 80) sendFile();
});

function sendFile() {
  cart.classList.add("swipe");

  socket.emit("cart-start", {
    name: file.name,
    size: file.size
  });

  const chunkSize = 30 * 1024 * 1024;
  let offset = 0;
  const reader = new FileReader();

  reader.onload = e => {
    socket.emit("file-chunk", {
      data: e.target.result,
      name: file.name
    });
    offset += chunkSize;
    if (offset < file.size) read();
    else socket.emit("file-done", { name: file.name });
  };

  function read() {
    reader.readAsArrayBuffer(file.slice(offset, offset + chunkSize));
  }
  read();
}
</script>
</body>
</html>
