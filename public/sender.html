<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Send Cart</title>

<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:system-ui;
  overflow:hidden;
}

h1{text-align:center;margin:20px}

input{display:block;margin:20px auto}

#cart{
  position:fixed;
  bottom:-200px;
  left:0;
  right:0;
  height:180px;
  background:linear-gradient(180deg,#ff0055,#ff8800);
  border-radius:30px 30px 0 0;
  padding:20px;
  transition:.4s ease;
  touch-action:none;
}

#cart.visible{bottom:0}

#cart h2{text-align:center;margin:0}

#filesList{
  max-height:90px;
  overflow:auto;
  margin-top:10px;
  font-size:.9em;
}

.handle{
  width:50px;
  height:6px;
  background:#000;
  border-radius:10px;
  margin:0 auto 10px;
}
</style>
</head>

<body>

<h1>Select Files</h1>
<input type="file" id="files" multiple>

<div id="cart">
  <div class="handle"></div>
  <h2>ðŸ›’ Send Cart</h2>
  <div id="filesList"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const ROOM = "room1";
socket.emit("join-room",ROOM);

const filesInput = document.getElementById("files");
const cart = document.getElementById("cart");
const list = document.getElementById("filesList");

let startY = null;
let sent = false;

filesInput.onchange = () => {
  list.innerHTML = "";
  [...filesInput.files].forEach(f=>{
    const d=document.createElement("div");
    d.textContent="â€¢ "+f.name;
    list.appendChild(d);
  });
  cart.classList.add("visible");
};

// swipe up gesture
cart.addEventListener("touchstart",e=>{
  startY = e.touches[0].clientY;
});

cart.addEventListener("touchmove",e=>{
  if(!startY) return;
  const diff = startY - e.touches[0].clientY;
  if(diff > 120 && !sent){
    sent = true;
    sendCart();
  }
});

async function sendCart(){
  // animate cart OUT of phone
  cart.style.transition="1s cubic-bezier(.4,2,.6,1)";
  cart.style.bottom="120%";

  const files=[...filesInput.files];

  // tell PC cart is coming
  socket.emit("telekinesis-start",{
    room:ROOM,
    files:files.map(f=>f.name)
  });

  const CHUNK = 30*1024*1024;
  for(const f of files){
    const total = Math.ceil(f.size/CHUNK);
    for(let i=0;i<total;i++){
      const chunk=f.slice(i*CHUNK,(i+1)*CHUNK);
      const fd=new FormData();
      fd.append("chunk",chunk);
      fd.append("fileName",f.name);
      fd.append("chunkIndex",i);
      fd.append("totalChunks",total);
      fd.append("room",ROOM);
      await fetch("/upload-chunk",{method:"POST",body:fd});
    }
  }
}
</script>

</body>
</html>
